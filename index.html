<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rasoa en Ligne - Gestion & Boutique</title>
    
    <meta name="theme-color" content="#db2777">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .img-gradient {
            background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.6) 100%);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rasoa-online-v1';

        const { useState, useEffect, useMemo } = React;

        const Icons = {
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>,
            LayoutGrid: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Truck: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Loader: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        };

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('shop'); 
            const [clients, setClients] = useState([]);
            const [products, setProducts] = useState([]);
            const [deliveries, setDeliveries] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            
            const [newClient, setNewClient] = useState({ nom: '', contact: '', domicile: '', nombreAchats: '' });
            const [newDelivery, setNewDelivery] = useState({ clientName: '', item: '', status: 'En attente' });

            const getColRef = (collectionName) => {
                return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
            };

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const unsubClients = getColRef('clients').onSnapshot(s => {
                    setClients(s.docs.map(d => ({ id: d.id, ...d.data() })));
                }, err => console.error(err));

                const unsubProducts = getColRef('products').onSnapshot(s => {
                    setProducts(s.docs.map(d => ({ id: d.id, ...d.data() })));
                }, err => console.error(err));

                const unsubDeliveries = getColRef('deliveries').onSnapshot(s => {
                    setDeliveries(s.docs.map(d => ({ id: d.id, ...d.data() })));
                }, err => console.error(err));

                return () => { unsubClients(); unsubProducts(); unsubDeliveries(); };
            }, [user]);

            const handleFileUpload = (productId, e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    updateProduct(productId, 'img', reader.result);
                };
                reader.readAsDataURL(file);
            };

            const updateProduct = async (id, field, value) => {
                await getColRef('products').doc(id).update({ [field]: value });
            };

            const addProduct = async () => {
                await getColRef('products').add({
                    name: 'Nouvel Article',
                    img: '',
                    createdAt: Date.now()
                });
            };

            const addClient = async () => {
                if (!newClient.nom) return;
                await getColRef('clients').add({
                    ...newClient, 
                    createdAt: Date.now(), 
                    nombreAchats: parseInt(newClient.nombreAchats) || 0
                });
                setNewClient({ nom: '', contact: '', domicile: '', nombreAchats: '' });
            };

            const addDelivery = async () => {
                if (!newDelivery.clientName || !newDelivery.item) return;
                await getColRef('deliveries').add({
                    ...newDelivery, 
                    createdAt: Date.now()
                });
                setNewDelivery({ clientName: '', item: '', status: 'En attente' });
            };

            const updateDeliveryStatus = async (id, status) => {
                await getColRef('deliveries').doc(id).update({ status });
            };

            const deleteItem = async (col, id) => {
                if (window.confirm("Confirmer la suppression ?")) {
                    await getColRef(col).doc(id).delete();
                }
            };

            const filteredClients = useMemo(() => {
                return clients.filter(c => c.nom?.toLowerCase().includes(searchTerm.toLowerCase())).sort((a,b) => b.createdAt - a.createdAt);
            }, [clients, searchTerm]);

            if (!user) return <div className="h-screen flex items-center justify-center text-pink-600"><Icons.Loader /></div>;

            return (
                <div className="min-h-screen flex flex-col pb-24">
                    <nav className="bg-white border-b sticky top-0 z-50 px-4 h-16 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-pink-600 p-2 rounded-xl text-white"><Icons.Zap /></div>
                            <span className="text-lg font-black tracking-tighter uppercase">Rasoa <span className="text-pink-600">App</span></span>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-xl gap-1">
                            {['shop', 'admin', 'delivery', 'settings'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`p-2 rounded-lg transition ${activeTab === tab ? 'bg-white shadow-sm text-pink-600' : 'text-slate-500'}`}>
                                    {tab === 'shop' && <Icons.LayoutGrid />}
                                    {tab === 'admin' && <Icons.Users />}
                                    {tab === 'delivery' && <Icons.Truck />}
                                    {tab === 'settings' && <Icons.Settings />}
                                </button>
                            ))}
                        </div>
                    </nav>

                    <main className="p-4">
                        {activeTab === 'shop' && (
                            <div className="grid grid-cols-2 gap-4">
                                {products.map(item => (
                                    <div key={item.id} className="bg-white rounded-3xl overflow-hidden shadow-sm border border-slate-100">
                                        <div className="h-40 relative">
                                            {item.img ? <img src={item.img} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-slate-100 flex items-center justify-center text-slate-300"><Icons.Image /></div>}
                                            <div className="absolute inset-0 img-gradient"></div>
                                        </div>
                                        <div className="p-3">
                                            <p className="text-xs font-bold uppercase truncate">{item.name || 'Sans nom'}</p>
                                            <span className="text-[10px] text-green-600 font-black">EN STOCK</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'admin' && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-3xl shadow-sm border space-y-3">
                                    <h3 className="text-[10px] font-black uppercase text-slate-400">Nouveau Client</h3>
                                    <input placeholder="Nom" className="w-full bg-slate-50 p-4 rounded-2xl outline-none" value={newClient.nom} onChange={e => setNewClient({...newClient, nom: e.target.value})} />
                                    <input placeholder="Contact (Tél)" className="w-full bg-slate-50 p-4 rounded-2xl outline-none" value={newClient.contact} onChange={e => setNewClient({...newClient, contact: e.target.value})} />
                                    <input placeholder="Lieu / Domicile" className="w-full bg-slate-50 p-4 rounded-2xl outline-none" value={newClient.domicile} onChange={e => setNewClient({...newClient, domicile: e.target.value})} />
                                    <input type="number" placeholder="Nombre d'achats" className="w-full bg-slate-50 p-4 rounded-2xl outline-none" value={newClient.nombreAchats} onChange={e => setNewClient({...newClient, nombreAchats: e.target.value})} />
                                    <button onClick={addClient} className="w-full bg-slate-900 text-white font-black py-4 rounded-2xl">Ajouter Client</button>
                                </div>
                                <div className="space-y-3">
                                    {filteredClients.map(c => (
                                        <div key={c.id} className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center">
                                            <div className="space-y-1">
                                                <div className="flex items-center gap-2">
                                                    <p className="font-bold">{c.nom}</p>
                                                    <span className="bg-pink-100 text-pink-600 text-[10px] px-2 py-0.5 rounded-full font-bold">{c.nombreAchats || 0} achats</span>
                                                </div>
                                                <p className="text-xs text-slate-400">{c.contact} • {c.domicile || 'Lieu non défini'}</p>
                                            </div>
                                            <button onClick={() => deleteItem('clients', c.id)} className="text-slate-200 hover:text-red-500 p-2"><Icons.X /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'delivery' && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-3xl shadow-sm border space-y-3">
                                    <h3 className="text-[10px] font-black uppercase text-slate-400">Nouvelle Livraison</h3>
                                    <select 
                                        className="w-full bg-slate-50 p-4 rounded-2xl outline-none appearance-none font-bold"
                                        value={newDelivery.clientName}
                                        onChange={e => setNewDelivery({...newDelivery, clientName: e.target.value})}
                                    >
                                        <option value="">Choisir un client existant...</option>
                                        {clients.map(c => <option key={c.id} value={c.nom}>{c.nom}</option>)}
                                    </select>
                                    <input placeholder="Article (ex: Crocs Lagon)" className="w-full bg-slate-50 p-4 rounded-2xl outline-none" value={newDelivery.item} onChange={e => setNewDelivery({...newDelivery, item: e.target.value})} />
                                    <button onClick={addDelivery} className="w-full bg-pink-600 text-white font-black py-4 rounded-2xl">Lancer Livraison</button>
                                </div>
                                <div className="space-y-4">
                                    {deliveries.map(d => (
                                        <div key={d.id} className="bg-white p-4 rounded-3xl border border-slate-100 flex flex-col gap-3">
                                            <div className="flex justify-between">
                                                <div>
                                                    <p className="font-black text-sm uppercase">{d.item}</p>
                                                    <p className="text-xs text-slate-500">Client: {d.clientName}</p>
                                                </div>
                                                <div className={`px-3 py-1 rounded-full text-[10px] font-bold h-fit ${d.status === 'Livré' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}`}>
                                                    {d.status}
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                {['En attente', 'En cours', 'Livré'].map(s => (
                                                    <button key={s} onClick={() => updateDeliveryStatus(d.id, s)} className={`flex-1 py-2 rounded-xl text-[10px] font-bold border transition ${d.status === s ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-400 border-slate-100'}`}>
                                                        {s}
                                                    </button>
                                                ))}
                                            </div>
                                            <button onClick={() => deleteItem('deliveries', d.id)} className="text-[10px] text-red-300 font-bold self-end uppercase p-1">Supprimer</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-3xl border shadow-sm">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-black uppercase tracking-tighter">Catalogue</h2>
                                        <button onClick={addProduct} className="bg-pink-600 text-white p-3 rounded-full shadow-lg"><Icons.Plus /></button>
                                    </div>
                                    <div className="space-y-6">
                                        {products.map(p => (
                                            <div key={p.id} className="p-4 bg-slate-50 rounded-3xl space-y-4 border border-slate-100 relative">
                                                <button onClick={() => deleteItem('products', p.id)} className="absolute -top-2 -right-2 bg-white border shadow-sm p-2 rounded-full text-red-400"><Icons.Trash /></button>
                                                <div className="flex items-center gap-4">
                                                    <div className="w-24 h-24 bg-white rounded-2xl overflow-hidden border relative flex items-center justify-center shrink-0">
                                                        {p.img ? <img src={p.img} className="w-full h-full object-cover" /> : <Icons.Image />}
                                                        <label className="absolute inset-0 bg-black/40 opacity-0 hover:opacity-100 transition flex items-center justify-center cursor-pointer">
                                                            <span className="text-[10px] text-white font-bold">CHANGER</span>
                                                            <input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(p.id, e)} />
                                                        </label>
                                                    </div>
                                                    <div className="flex-1 space-y-3">
                                                        <div>
                                                            <label className="text-[9px] font-black text-slate-400 uppercase">Nom de l'article</label>
                                                            <input 
                                                                className="w-full bg-white border p-3 rounded-xl font-bold outline-none text-sm focus:border-pink-500" 
                                                                value={p.name} 
                                                                placeholder="Ex: Crocs Lagon"
                                                                onChange={e => updateProduct(p.id, 'name', e.target.value)} 
                                                            />
                                                        </div>
                                                        <label className="inline-block bg-slate-200 px-4 py-2 rounded-xl text-[10px] font-black cursor-pointer hover:bg-slate-300 transition">
                                                            CHOISIR IMAGE (PARCOURIR)
                                                            <input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(p.id, e)} />
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-4 flex justify-around items-center safe-area-bottom z-50 shadow-lg">
                        <button onClick={() => setActiveTab('shop')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'shop' ? 'text-pink-600 scale-110' : 'text-slate-400'}`}>
                            <Icons.LayoutGrid />
                            <span className="text-[9px] font-black uppercase">Boutique</span>
                        </button>
                        <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'admin' ? 'text-pink-600 scale-110' : 'text-slate-400'}`}>
                            <Icons.Users />
                            <span className="text-[9px] font-black uppercase">Clients</span>
                        </button>
                        <button onClick={() => setActiveTab('delivery')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'delivery' ? 'text-pink-600 scale-110' : 'text-slate-400'}`}>
                            <Icons.Truck />
                            <span className="text-[9px] font-black uppercase">Livraison</span>
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'settings' ? 'text-pink-600 scale-110' : 'text-slate-400'}`}>
                            <Icons.Settings />
                            <span className="text-[9px] font-black uppercase">Stock</span>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>